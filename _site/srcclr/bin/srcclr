#! /usr/bin/env bash
# Runs the SourceClear Agent
#
PRG="`which "$0" 2>/dev/null`"
if [ ! -f "$PRG" ]; then
  PRG="$0"
fi
# stolen from bin/ant {{{
# lightly modified to not leak variables
# need this for relative symlinks
while [ -h "$PRG" ]; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    unset ls
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
    unset link
done
# }}}

TOPDIR="`dirname "$PRG"`"
TOPDIR="`cd "${TOPDIR}/.." && pwd`"
java=${TOPDIR}/jre/bin/java

command_exist() {
  type "$@" > /dev/null 2>&1
}

#
# Gather OS information
#
if [ -r /etc/os-release ]; then
  . /etc/os-release
  if ! [[ "$ID" = ubuntu || "$ID" = debian || "$ID" = centos || "$ID" = fedora ]] ; then
    echo "WARNING: SourceClear has not validated support of $ID version $VERSION"  >&2
  fi
else
  # test for centos version 6 that does not have /etc/os-release.
  if [ -r /etc/system-release ] ; then
    ID=$(awk '{print $1;}' /etc/system-release | tr [A-Z] [a-z])
    VERSION_ID=$(awk '{print $3;}' /etc/system-release)
    if ! [[ "$ID" = centos && (( "$VERSION_ID" > 6 )) ]] ; then
      echo "WARNING: SourceClear has not validated support of $ID version $VERSION_ID"  >&2
      exit 1
    fi
  else
    if (command_exist sw_vers); then
      # might be a mac
      ID=$(sw_vers | grep ProductName | awk -F':' '{print tolower($2)}' | tr -d '[:space:]')
      VERSION_ID=$(sw_vers | grep ProductVersion | awk -F':' '{print $2}' | tr -d '[:space:]')
    else
      echo "WARNING: SourceClear has not validated support of $ID version $VERSION"  >&2
    fi
  fi
fi


if ! command_exist git; then
    echo "Please install git to run $0" >&2
    if [[ -r /etc/os-release ]]; then
       . /etc/os-release
       if [[ $ID = ubuntu ]]; then
           read _ UBUNTU_VERSION_NAME <<< "$VERSION"
	   cat << END_INSTALL_GIT
One way to install git on ubuntu is to:
sudo apt-get update
sudo apt-get install git
END_INSTALL_GIT
       fi
    fi
    exit 1
fi

# magic to turn this process into running java with the appended jar.
exec -a srcclr "$java" $JAVA_OPTS -jar "${TOPDIR}/"srcclr-*jar "$@"
exit 1
